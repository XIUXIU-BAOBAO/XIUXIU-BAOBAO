<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒä¸šå¥åº·ç­”é¢˜ç³»ç»Ÿ</title>
    <style>
        /* é‡ç½®æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; }
        
        /* å®¹å™¨ */
        .container { max-width: 100%; margin: 0 auto; padding: 15px; }
        
        /* å¤´éƒ¨ */
        header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e1e4e8; position: relative; }
        h1 { color: #2c3e50; margin-bottom: 10px; font-size: 1.5rem; }
        .description { color: #7f8c8d; font-size: 14px; }
        .overall-progress { background: #3498db; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin-top: 10px; }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content { display: flex; flex-direction: column; gap: 15px; }
        
        /* ç« èŠ‚é¢æ¿ */
        .chapters-panel { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 15px; }
        .chapters-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #2c3e50; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .chapters-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .chapter-item { background: #bdc3c7; color: white; text-align: center; padding: 10px 5px; border-radius: 4px; cursor: pointer; transition: all 0.3s; font-size: 14px; position: relative; overflow: hidden; }
        .chapter-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .chapter-item.active { border: 2px solid #3498db; }
        .chapter-item .progress-bar { position: absolute; bottom: 0; left: 0; height: 6px; transition: width 0.3s; }
        
        /* ç‰¹æ®ŠåŠŸèƒ½æŒ‰é’® */
        .special-books { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .special-book-btn { padding: 12px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; text-align: center; }
        .special-book-btn:hover { background: #8e44ad; }
        .special-book-btn.active { background: #e74c3c; font-weight: bold; }
        
        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 4px; }
        .stat-value { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; }
        .total { background: #ecf0f1; color: #7f8c8d; }
        .answered { background: #3498db; color: white; }
        .correct { background: #2ecc71; color: white; }
        .wrong { background: #e74c3c; color: white; }
        
        /* é¢˜ç›®ç½‘æ ¼ */
        .questions-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 15px; }
        .question-item { background: #bdc3c7; color: white; text-align: center; padding: 8px 3px; border-radius: 4px; cursor: pointer; transition: all 0.3s; font-size: 12px; }
        .question-item:hover { opacity: 0.9; }
        .question-item.answered { background: #3498db; }
        .question-item.correct { background: #2ecc71; }
        .question-item.wrong { background: #e74c3c; }
        .question-item.marked { background: #3498db; }
        
        /* é¢˜ç›®è¯¦æƒ… */
        .question-detail { background: #f8f9fa; border-radius: 8px; padding: 15px; }
        .question-title { font-size: 16px; margin-bottom: 15px; color: #2c3e50; line-height: 1.4; }
        .options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .option { padding: 12px 15px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .option:hover { background: #f1f2f6; }
        .option.selected { background: #3498db; color: white; border-color: #2980b9; }
        .option.correct-answer { background: #2ecc71; color: white; border-color: #27ae60; }
        .option.wrong-answer { background: #e74c3c; color: white; border-color: #c0392b; }
        
        /* æ“ä½œæŒ‰é’® */
        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; text-align: center; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-success:hover { background: #27ae60; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-info { background: #1abc9c; color: white; }
        .btn-info:hover { background: #16a085; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state { text-align: center; padding: 40px 20px; color: #7f8c8d; }
        .empty-state i { font-size: 48px; margin-bottom: 15px; color: #bdc3c7; }
        
        /* å¯¼å…¥å¯¼å‡ºåŒºåŸŸ */
        .import-section { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #bdc3c7; }
        .import-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .import-textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-size: 14px; margin-bottom: 10px; }
        .import-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .format-example { margin-top: 10px; font-size: 12px; color: #7f8c8d; }
        .question-type { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .single-choice { background: #3498db; color: white; }
        .multiple-choice { background: #9b59b6; color: white; }
        .true-false { background: #f39c12; color: white; }
        
        /* å¯¼èˆª */
        .navigation { display: flex; justify-content: space-between; margin-top: 20px; }
        .nav-btn { padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        
        /* éšè—ç±» */
        .hidden { display: none; }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (min-width: 768px) {
            .container { max-width: 768px; }
            .chapters-grid { grid-template-columns: repeat(6, 1fr); }
            .questions-grid { grid-template-columns: repeat(8, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¦–é¡µ -->
        <div id="homePage">
            <header>
                <h1>èŒä¸šå¥åº·ç­”é¢˜ç³»ç»Ÿ</h1>
                <p class="description">å…±72ç« ï¼Œæ”¯æŒå•é€‰é¢˜ã€å¤šé€‰é¢˜å’Œåˆ¤æ–­é¢˜</p>
                <div class="overall-progress" id="overallProgress">æ€»è¿›åº¦: 0%</div>
            </header>
            
            <div class="main-content">
                <div class="chapters-panel">
                    <div class="chapters-title">ç« èŠ‚åˆ—è¡¨</div>
                    
                    <div class="special-books">
                        <button class="special-book-btn" id="wrongQuestionsBook">é”™é¢˜æœ¬</button>
                        <button class="special-book-btn" id="markedQuestionsBook">æ ‡è®°æœ¬</button>
                    </div>
                    
                    <div class="chapters-grid" id="chaptersGrid">
                        <!-- ç« èŠ‚å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="import-section">
                        <div class="import-title">é¢˜åº“ç®¡ç†</div>
                        
                        <div class="import-actions">
                            <button class="btn btn-primary" id="importPageBtn">å¯¼å…¥é¢˜åº“</button>
                            <button class="btn btn-warning" id="exportPageBtn">å¯¼å‡ºé¢˜åº“</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç« èŠ‚é¢˜ç›®åˆ—è¡¨é¡µ -->
        <div id="chapterPage" class="hidden">
            <header>
                <button class="btn btn-primary" id="backToHomeBtn">è¿”å›é¦–é¡µ</button>
                <h1 id="chapterTitle">ç¬¬1ç« </h1>
            </header>
            
            <div class="main-content">
                <div class="stats">
                    <div class="stat-item total">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">æ€»é¢˜æ•°</div>
                    </div>
                    <div class="stat-item answered">
                        <div class="stat-value" id="answeredCount">0</div>
                        <div class="stat-label">å·²ç­”</div>
                    </div>
                    <div class="stat-item correct">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">æ­£ç¡®</div>
                    </div>
                    <div class="stat-item wrong">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">é”™è¯¯</div>
                    </div>
                </div>
                
                <div class="questions-grid" id="questionsGrid">
                    <!-- é¢˜ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="actions">
                    <button class="btn btn-danger" id="clearAnswers">æ¸…ç©ºç­”é¢˜è®°å½•</button>
                    <button class="btn btn-warning" id="shuffleBtn">æ‰“ä¹±é¢˜ç›®é¡ºåº</button>
                    <button class="btn btn-info" id="startPractice">å¼€å§‹ç»ƒä¹ </button>
                </div>
            </div>
        </div>
        
        <!-- é¢˜ç›®è¯¦æƒ…é¡µ -->
        <div id="questionPage" class="hidden">
            <header>
                <button class="btn btn-primary" id="backToChapterBtn">è¿”å›ç« èŠ‚</button>
                <h1 id="questionPageTitle">é¢˜ç›®è¯¦æƒ…</h1>
            </header>
            
            <div class="main-content">
                <div class="question-detail">
                    <div class="question-title" id="questionTitle"></div>
                    <div class="options" id="optionsContainer"></div>
                    
                    <div class="actions">
                        <button class="btn btn-info" id="markQuestion">æ ‡è®°æ­¤é¢˜</button>
                        <button class="btn btn-primary" id="submitAnswer">æäº¤ç­”æ¡ˆ</button>
                        <button class="btn btn-success" id="nextQuestion">ä¸‹ä¸€é¢˜</button>
                    </div>
                </div>
                
                <div class="navigation">
                    <button class="nav-btn btn-primary" id="prevQuestion">ä¸Šä¸€é¢˜</button>
                    <button class="nav-btn btn-success" id="nextQuestionNav">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </div>
        
        <!-- å¯¼å…¥å¯¼å‡ºé¡µ -->
        <div id="importExportPage" class="hidden">
            <header>
                <button class="btn btn-primary" id="backToHomeFromImportBtn">è¿”å›é¦–é¡µ</button>
                <h1>é¢˜åº“ç®¡ç†</h1>
            </header>
            
            <div class="main-content">
                <div class="import-section">
                    <div class="import-title">å¯¼å…¥é¢˜åº“</div>
                    <textarea class="import-textarea" id="importTextarea" placeholder="è¯·å°†é¢˜åº“æ–‡æœ¬ç²˜è´´åˆ°è¿™é‡Œ..."></textarea>
                    
                    <div class="import-actions">
                        <button class="btn btn-primary" id="importBtn">å¯¼å…¥åˆ°æœ¬ç« </button>
                        <button class="btn btn-danger" id="clearChapterBtn">æ¸…ç©ºæœ¬ç« å†…å®¹</button>
                    </div>
                    
                    <div class="format-example">
                        <p><strong>æ ¼å¼è¯´æ˜ï¼š</strong></p>
                        <p><strong>å•é€‰é¢˜ï¼š</strong> é¢˜ç›®å†…å®¹ï¼ˆAï¼‰</p>
                        <p><strong>å¤šé€‰é¢˜ï¼š</strong> é¢˜ç›®å†…å®¹ï¼ˆABï¼‰æˆ–ï¼ˆABCï¼‰</p>
                        <p><strong>åˆ¤æ–­é¢˜ï¼š</strong> é¢˜ç›®å†…å®¹ï¼ˆå¯¹ï¼‰æˆ–ï¼ˆé”™ï¼‰</p>
                        <p>A. é€‰é¡¹A</p>
                        <p>B. é€‰é¡¹B</p>
                        <p>C. é€‰é¡¹C</p>
                        <p>D. é€‰é¡¹D</p>
                        <p>E. é€‰é¡¹E</p>
                        <p>F. é€‰é¡¹F</p>
                    </div>
                </div>
                
                <div class="import-section">
                    <div class="import-title">å¯¼å‡ºé¢˜åº“</div>
                    <div class="import-actions">
                        <button class="btn btn-warning" id="exportBtn">å¯¼å‡ºé¢˜åº“</button>
                        <button class="btn btn-danger" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                        <button class="btn btn-success" id="forceReloadBtn">å¼ºåˆ¶é‡æ–°åŠ è½½é¢˜åº“</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¢˜åº“æ•°æ® - åˆå§‹ä¸ºç©º
        let questionBank = {};
        
        // å­˜å‚¨æ¯ä¸ªç« èŠ‚çš„é¢˜ç›®é¡ºåºçŠ¶æ€
        let chapterOrderState = {};
        
        // å½“å‰çŠ¶æ€
        let currentChapter = 0;
        let currentQuestion = 0;
        let currentMode = 'chapter'; // 'chapter', 'wrong', 'marked'
        
        // é¢˜åº“ç‰ˆæœ¬æ§åˆ¶
        const QUESTION_BANK_VERSION = '1.3'; // æ¯æ¬¡æ›´æ–°é¢˜åº“æ—¶ä¿®æ”¹æ­¤ç‰ˆæœ¬å·
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChapters();
            loadChapterOrderState();
            
            // æ£€æŸ¥ç‰ˆæœ¬å·ï¼Œå¦‚æœç‰ˆæœ¬ä¸åŒåˆ™é‡æ–°åŠ è½½
            const storedVersion = localStorage.getItem('questionBankVersion');
            const storedBank = localStorage.getItem('questionBank');
            
            if (storedBank && storedVersion === QUESTION_BANK_VERSION) {
                // ç‰ˆæœ¬ä¸€è‡´ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨
                loadQuestionBankFromStorage();
                updateStats();
                updateOverallProgress();
                updateVersionInfo('å·²åŠ è½½æœ¬åœ°é¢˜åº“ v' + QUESTION_BANK_VERSION);
            } else {
                // ç‰ˆæœ¬ä¸ä¸€è‡´æˆ–æ²¡æœ‰æœ¬åœ°å­˜å‚¨ï¼ŒåŠ è½½è¿œç¨‹é¢˜åº“
                localStorage.removeItem('questionBank'); // æ¸…é™¤æ—§æ•°æ®
                loadDefaultQuestionBank();
            }
            
            // æ·»åŠ é¡µé¢å¯¼èˆªäº‹ä»¶
            document.getElementById('wrongQuestionsBook').addEventListener('click', showWrongQuestions);
            document.getElementById('markedQuestionsBook').addEventListener('click', showMarkedQuestions);
            document.getElementById('importPageBtn').addEventListener('click', showImportExportPage);
            document.getElementById('exportPageBtn').addEventListener('click', showImportExportPage);
            document.getElementById('backToHomeBtn').addEventListener('click', showHomePage);
            document.getElementById('backToChapterBtn').addEventListener('click', showChapterPage);
            document.getElementById('backToHomeFromImportBtn').addEventListener('click', showHomePage);
            
            // æ·»åŠ å¯¼å…¥æŒ‰é’®äº‹ä»¶
            document.getElementById('importBtn').addEventListener('click', importQuestions);
            document.getElementById('exportBtn').addEventListener('click', exportQuestionBank);
            document.getElementById('clearChapterBtn').addEventListener('click', clearCurrentChapter);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
            document.getElementById('forceReloadBtn').addEventListener('click', forceReloadQuestionBank);
            
            // æ·»åŠ é¢˜ç›®æ“ä½œäº‹ä»¶
            document.getElementById('clearAnswers').addEventListener('click', clearChapterAnswers);
            document.getElementById('shuffleBtn').addEventListener('click', toggleChapterShuffle);
            document.getElementById('startPractice').addEventListener('click', startPractice);
            
            // æ·»åŠ é¢˜ç›®å¯¼èˆªäº‹ä»¶
            document.getElementById('prevQuestion').addEventListener('click', showPreviousQuestion);
            document.getElementById('nextQuestionNav').addEventListener('click', showNextQuestion);
        });
        
        // é¡µé¢å¯¼èˆªå‡½æ•°
        function showHomePage() {
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('chapterPage').classList.add('hidden');
            document.getElementById('questionPage').classList.add('hidden');
            document.getElementById('importExportPage').classList.add('hidden');
        }
        
        function showChapterPage() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('chapterPage').classList.remove('hidden');
            document.getElementById('questionPage').classList.add('hidden');
            document.getElementById('importExportPage').classList.add('hidden');
        }
        
        function showQuestionPage() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('chapterPage').classList.add('hidden');
            document.getElementById('questionPage').classList.remove('hidden');
            document.getElementById('importExportPage').classList.add('hidden');
        }
        
        function showImportExportPage() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('chapterPage').classList.add('hidden');
            document.getElementById('questionPage').classList.add('hidden');
            document.getElementById('importExportPage').classList.remove('hidden');
        }
        
        // å¼ºåˆ¶é‡æ–°åŠ è½½é¢˜åº“
        function forceReloadQuestionBank() {
            if (confirm('ç¡®å®šè¦å¼ºåˆ¶é‡æ–°åŠ è½½é¢˜åº“å—ï¼Ÿè¿™å°†æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„é¢˜åº“æ•°æ®ã€‚')) {
                localStorage.removeItem('questionBank');
                localStorage.removeItem('questionBankVersion');
                loadDefaultQuestionBank();
            }
        }
        
        // æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º
        function updateVersionInfo(text) {
            // æš‚æ—¶æ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
        }
        
        // åŠ è½½é»˜è®¤é¢˜åº“å‡½æ•°
        function loadDefaultQuestionBank() {
            // æ·»åŠ ç‰ˆæœ¬å·å’Œéšæœºå‚æ•°é˜²æ­¢ç¼“å­˜
            const defaultBankUrl = './question-bank.json?v=' + QUESTION_BANK_VERSION + '&t=' + new Date().getTime();
            
            fetch(defaultBankUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                    }
                    return response.json();
                })
                .then(data => {
                    questionBank = data;
                    saveQuestionBankToStorage();
                    // ä¿å­˜ç‰ˆæœ¬å·åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('questionBankVersion', QUESTION_BANK_VERSION);
                    updateChapterImportStatus();
                    updateStats();
                    updateOverallProgress();
                    
                    console.log('é»˜è®¤é¢˜åº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:' + QUESTION_BANK_VERSION);
                })
                .catch(error => {
                    console.error('åŠ è½½é»˜è®¤é¢˜åº“å¤±è´¥:', error);
                    // å¦‚æœè¿œç¨‹åŠ è½½å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    loadQuestionBankFromStorage();
                });
        }
        
        // åˆå§‹åŒ–ç« èŠ‚åˆ—è¡¨
        function initChapters() {
            const chaptersGrid = document.getElementById('chaptersGrid');
            
            for (let i = 1; i <= 72; i++) {
                const chapterItem = document.createElement('div');
                chapterItem.className = 'chapter-item';
                chapterItem.textContent = `ç¬¬${i}ç« `;
                chapterItem.dataset.chapter = i;
                
                // æ·»åŠ è¿›åº¦æ¡
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                chapterItem.appendChild(progressBar);
                
                chapterItem.addEventListener('click', function() {
                    selectChapter(parseInt(this.dataset.chapter));
                });
                
                chaptersGrid.appendChild(chapterItem);
            }
            
            updateChapterImportStatus();
        }
        
        // æ›´æ–°ç« èŠ‚å¯¼å…¥çŠ¶æ€å’Œå®ŒæˆçŠ¶æ€
        function updateChapterImportStatus() {
            document.querySelectorAll('.chapter-item').forEach(item => {
                const chapter = parseInt(item.dataset.chapter);
                const questions = questionBank[chapter] || [];
                
                // è®¡ç®—ç« èŠ‚å®Œæˆåº¦
                let completedCount = 0;
                if (questions.length > 0) {
                    questions.forEach(q => {
                        const userAnswer = getUserAnswer(chapter, q.id);
                        if (userAnswer && userAnswer !== '') {
                            completedCount++;
                        }
                    });
                }
                
                const progress = questions.length > 0 ? (completedCount / questions.length) : 0;
                
                // æ›´æ–°è¿›åº¦æ¡é¢œè‰²å’Œå®½åº¦
                const progressBar = item.querySelector('.progress-bar');
                progressBar.style.width = `${progress * 100}%`;
                
                // æ ¹æ®è¿›åº¦è®¾ç½®é¢œè‰² (çº¢è‰² -> é»„è‰² -> ç»¿è‰²)
                if (progress === 0) {
                    progressBar.style.backgroundColor = '#e74c3c'; // çº¢è‰²
                } else if (progress < 0.5) {
                    progressBar.style.backgroundColor = '#f39c12'; // é»„è‰²
                } else if (progress < 1) {
                    progressBar.style.backgroundColor = '#2ecc71'; // æµ…ç»¿è‰²
                } else {
                    progressBar.style.backgroundColor = '#27ae60'; // æ·±ç»¿è‰²
                }
                
                // æ›´æ–°ç« èŠ‚èƒŒæ™¯è‰²
                if (questions.length > 0) {
                    item.style.backgroundColor = '#3498db'; // æœ‰é¢˜ç›®æ—¶ä¸ºè“è‰²
                } else {
                    item.style.backgroundColor = '#bdc3c7'; // æ— é¢˜ç›®æ—¶ä¸ºç°è‰²
                }
            });
        }
        
        // é€‰æ‹©ç« èŠ‚
        function selectChapter(chapter) {
            currentChapter = chapter;
            currentMode = 'chapter';
            
            // æ›´æ–°ç« èŠ‚æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.chapter-item[data-chapter="${chapter}"]`).classList.add('active');
            
            // æ›´æ–°ç‰¹æ®ŠæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.special-book-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ›´æ–°å½“å‰ç« èŠ‚æ ‡é¢˜
            document.getElementById('chapterTitle').textContent = `ç¬¬${chapter}ç« `;
            
            // æ˜¾ç¤ºé¢˜ç›®ç½‘æ ¼
            displayQuestionsGrid(chapter);
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // æ˜¾ç¤ºç« èŠ‚é¡µé¢
            showChapterPage();
        }
        
        // æ˜¾ç¤ºé¢˜ç›®ç½‘æ ¼
        function displayQuestionsGrid(chapter) {
            const questions = questionBank[chapter] || [];
            const questionsGrid = document.getElementById('questionsGrid');
            
            if (questions.length === 0) {
                questionsGrid.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ“</i>
                        <p>æœ¬ç« æš‚æ— é¢˜ç›®ï¼Œè¯·å¯¼å…¥é¢˜åº“</p>
                    </div>
                `;
                return;
            }
            
            // è·å–å½“å‰ç« èŠ‚çš„é¡ºåºçŠ¶æ€
            const orderState = chapterOrderState[chapter] || { shuffled: false, order: [] };
            
            // åˆ›å»ºé¢˜ç›®ç½‘æ ¼
            let html = '';
            
            // æ ¹æ®æ˜¯å¦æ‰“ä¹±å†³å®šæ˜¾ç¤ºé¡ºåº
            let displayOrder = [];
            if (orderState.shuffled && orderState.order.length === questions.length) {
                // ä½¿ç”¨æ‰“ä¹±åçš„é¡ºåº
                displayOrder = orderState.order;
            } else {
                // ä½¿ç”¨åŸå§‹é¡ºåº
                displayOrder = questions.map(q => q.id);
            }
            
            displayOrder.forEach(questionId => {
                const q = questions.find(q => q.id === questionId);
                if (!q) return;
                
                const status = getUserAnswerStatus(chapter, q.id);
                const isMarked = isQuestionMarked(chapter, q.id);
                html += `<div class="question-item ${status} ${isMarked ? 'marked' : ''}" data-question="${q.id}">${q.id}</div>`;
            });
            
            questionsGrid.innerHTML = html;
            
            // æ·»åŠ é¢˜ç›®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.question-item').forEach(item => {
                item.addEventListener('click', function() {
                    const questionId = parseInt(this.dataset.question);
                    displayQuestion(chapter, questionId);
                });
            });
        }
        
        // æ‰“ä¹±æˆ–æ¢å¤ç« èŠ‚é¢˜ç›®é¡ºåº
        function toggleChapterShuffle(chapter) {
            const questions = questionBank[chapter] || [];
            if (questions.length === 0) return;
            
            // è·å–å½“å‰ç« èŠ‚çš„é¡ºåºçŠ¶æ€
            const orderState = chapterOrderState[chapter] || { shuffled: false, order: [] };
            
            if (orderState.shuffled) {
                // æ¢å¤åŸå§‹é¡ºåº
                orderState.shuffled = false;
                orderState.order = questions.map(q => q.id);
                document.getElementById('shuffleBtn').textContent = 'æ‰“ä¹±é¢˜ç›®é¡ºåº';
            } else {
                // æ‰“ä¹±é¢˜ç›®é¡ºåº
                orderState.shuffled = true;
                orderState.order = [...questions.map(q => q.id)];
                
                // Fisher-Yates æ´—ç‰Œç®—æ³•
                for (let i = orderState.order.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [orderState.order[i], orderState.order[j]] = [orderState.order[j], orderState.order[i]];
                }
                
                document.getElementById('shuffleBtn').textContent = 'æ¢å¤é¢˜ç›®é¡ºåº';
            }
            
            // ä¿å­˜çŠ¶æ€
            chapterOrderState[chapter] = orderState;
            saveChapterOrderState();
            
            // é‡æ–°æ˜¾ç¤ºé¢˜ç›®ç½‘æ ¼
            displayQuestionsGrid(chapter);
        }
        
        // å¼€å§‹ç»ƒä¹ 
        function startPractice() {
            const questions = questionBank[currentChapter] || [];
            if (questions.length === 0) return;
            
            // è·å–å½“å‰ç« èŠ‚çš„é¡ºåºçŠ¶æ€
            const orderState = chapterOrderState[currentChapter] || { shuffled: false, order: [] };
            
            let firstQuestionId;
            if (orderState.shuffled && orderState.order.length === questions.length) {
                // ä½¿ç”¨æ‰“ä¹±åçš„é¡ºåº
                firstQuestionId = orderState.order[0];
            } else {
                // ä½¿ç”¨åŸå§‹é¡ºåº
                firstQuestionId = questions[0].id;
            }
            
            displayQuestion(currentChapter, firstQuestionId);
        }
        
        // ä¿å­˜ç« èŠ‚é¡ºåºçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        function saveChapterOrderState() {
            localStorage.setItem('chapterOrderState', JSON.stringify(chapterOrderState));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç« èŠ‚é¡ºåºçŠ¶æ€
        function loadChapterOrderState() {
            const stored = localStorage.getItem('chapterOrderState');
            if (stored) {
                chapterOrderState = JSON.parse(stored);
            }
        }
        
        // æ˜¾ç¤ºé¢˜ç›®è¯¦æƒ…
        function displayQuestion(chapter, questionId) {
            let questions = [];
            let question = null;
            
            if (currentMode === 'chapter') {
                questions = questionBank[chapter] || [];
                question = questions.find(q => q.id === questionId);
            } else {
                // å¯¹äºç‰¹æ®Šæ¨¡å¼ï¼Œéœ€è¦ä»å¯¹åº”çš„é¢˜ç›®åˆ—è¡¨ä¸­æŸ¥æ‰¾
                if (currentMode === 'wrong') {
                    questions = getAllWrongQuestions();
                } else if (currentMode === 'marked') {
                    questions = getAllMarkedQuestions();
                }
                
                question = questions.find(q => q.chapter === chapter && q.id === questionId);
            }
            
            if (!question) {
                alert('é¢˜ç›®ä¸å­˜åœ¨');
                return;
            }
            
            currentQuestion = questionId;
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.getElementById('questionPageTitle').textContent = `ç¬¬${chapter}ç«  ç¬¬${questionId}é¢˜`;
            
            const questionTitle = document.getElementById('questionTitle');
            const optionsContainer = document.getElementById('optionsContainer');
            const markButton = document.getElementById('markQuestion');
            const submitButton = document.getElementById('submitAnswer');
            const nextButton = document.getElementById('nextQuestion');
            
            // è®¾ç½®é¢˜ç›®å’Œé¢˜å‹æ ‡è¯†
            let typeLabel = '';
            let typeClass = '';
            if (question.type === 'multiple') {
                typeLabel = 'å¤šé€‰é¢˜';
                typeClass = 'multiple-choice';
            } else if (question.type === 'true-false') {
                typeLabel = 'åˆ¤æ–­é¢˜';
                typeClass = 'true-false';
            } else {
                typeLabel = 'å•é€‰é¢˜';
                typeClass = 'single-choice';
            }
            
            questionTitle.innerHTML = `${question.question} <span class="question-type ${typeClass}">${typeLabel}</span>`;
            
            // è®¾ç½®é€‰é¡¹ - éšæœºæ‰“ä¹±é€‰é¡¹é¡ºåº
            optionsContainer.innerHTML = '';
            let shuffledOptions = shuffleOptions(question.options, question.type);
            
            shuffledOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.dataset.option = option.originalLabel; // ä½¿ç”¨åŸå§‹æ ‡ç­¾
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»é€‰æ‹©è¿‡
                const userAnswer = getUserAnswer(chapter, questionId);
                if (userAnswer) {
                    // å¤šé€‰é¢˜å’Œåˆ¤æ–­é¢˜å¯èƒ½æœ‰å¤šä¸ªç­”æ¡ˆ
                    if (question.type === 'multiple') {
                        if (userAnswer.includes(option.originalLabel)) {
                            optionElement.classList.add('selected');
                        }
                    } else {
                        if (userAnswer === option.originalLabel) {
                            optionElement.classList.add('selected');
                        }
                    }
                    
                    // å¦‚æœå·²ç»æäº¤ï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    if (userAnswer !== '') {
                        if (question.type === 'multiple') {
                            // å¤šé€‰é¢˜ï¼šæ­£ç¡®ç­”æ¡ˆåŒ…å«æ­¤é€‰é¡¹
                            if (question.answer.includes(option.originalLabel)) {
                                optionElement.classList.add('correct-answer');
                            } else if (userAnswer.includes(option.originalLabel) && !question.answer.includes(option.originalLabel)) {
                                // ç”¨æˆ·é€‰æ‹©äº†ä½†ç­”æ¡ˆä¸åŒ…å«
                                optionElement.classList.add('wrong-answer');
                            }
                        } else {
                            // å•é€‰é¢˜å’Œåˆ¤æ–­é¢˜
                            if (option.originalLabel === question.answer) {
                                optionElement.classList.add('correct-answer');
                            } else if (userAnswer === option.originalLabel && userAnswer !== question.answer) {
                                optionElement.classList.add('wrong-answer');
                            }
                        }
                    }
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆåªæœ‰åœ¨æœªæäº¤ç­”æ¡ˆæ—¶å¯ç”¨ï¼‰
                if (!userAnswer || userAnswer === '') {
                    optionElement.addEventListener('click', function() {
                        if (question.type === 'multiple') {
                            // å¤šé€‰é¢˜ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                            this.classList.toggle('selected');
                        } else {
                            // å•é€‰é¢˜å’Œåˆ¤æ–­é¢˜ï¼šåªèƒ½é€‰ä¸€ä¸ª
                            document.querySelectorAll('.option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            this.classList.add('selected');
                        }
                    });
                }
                
                optionsContainer.appendChild(optionElement);
            });
            
            // æ ¹æ®ç­”é¢˜çŠ¶æ€è°ƒæ•´æŒ‰é’®
            const userAnswer = getUserAnswer(chapter, questionId);
            if (userAnswer && userAnswer !== '') {
                submitButton.style.display = 'none';
                nextButton.style.display = 'inline-block';
            } else {
                submitButton.style.display = 'inline-block';
                nextButton.style.display = 'none';
            }
            
            // è®¾ç½®æ ‡è®°æŒ‰é’®çŠ¶æ€
            const isMarked = isQuestionMarked(chapter, questionId);
            markButton.textContent = isMarked ? 'å–æ¶ˆæ ‡è®°' : 'æ ‡è®°æ­¤é¢˜';
            
            // æ ‡è®°æŒ‰é’®äº‹ä»¶
            markButton.onclick = function() {
                const newMarkedState = !isQuestionMarked(chapter, questionId);
                setQuestionMarked(chapter, questionId, newMarkedState);
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                markButton.textContent = newMarkedState ? 'å–æ¶ˆæ ‡è®°' : 'æ ‡è®°æ­¤é¢˜';
                
                // æ›´æ–°é¢˜ç›®ç½‘æ ¼ä¸­çš„æ ‡è®°çŠ¶æ€
                updateQuestionGridItem(chapter, questionId);
                
                // å¦‚æœå½“å‰åœ¨æ ‡è®°æœ¬æ¨¡å¼ä¸‹ï¼Œåˆ·æ–°æ˜¾ç¤º
                if (currentMode === 'marked') {
                    showMarkedQuestions();
                }
            };
            
            // æäº¤æŒ‰é’®äº‹ä»¶
            submitButton.onclick = function() {
                let selectedOptions = [];
                if (question.type === 'multiple') {
                    // å¤šé€‰é¢˜ï¼šæ”¶é›†æ‰€æœ‰é€‰ä¸­çš„é€‰é¡¹
                    selectedOptions = Array.from(document.querySelectorAll('.option.selected'))
                        .map(opt => opt.dataset.option)
                        .sort()
                        .join('');
                } else {
                    // å•é€‰é¢˜å’Œåˆ¤æ–­é¢˜ï¼šè·å–é€‰ä¸­çš„é€‰é¡¹
                    const selectedOption = document.querySelector('.option.selected');
                    if (!selectedOption) {
                        alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                        return;
                    }
                    selectedOptions = selectedOption.dataset.option;
                }
                
                if (selectedOptions.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                    return;
                }
                
                const isCorrect = selectedOptions === question.answer;
                
                // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
                saveUserAnswer(chapter, questionId, selectedOptions, isCorrect);
                
                // æ›´æ–°é€‰é¡¹æ˜¾ç¤º
                document.querySelectorAll('.option').forEach(opt => {
                    if (question.type === 'multiple') {
                        // å¤šé€‰é¢˜ï¼šæ­£ç¡®ç­”æ¡ˆåŒ…å«æ­¤é€‰é¡¹
                        if (question.answer.includes(opt.dataset.option)) {
                            opt.classList.add('correct-answer');
                        } else if (selectedOptions.includes(opt.dataset.option) && !question.answer.includes(opt.dataset.option)) {
                            // ç”¨æˆ·é€‰æ‹©äº†ä½†ç­”æ¡ˆä¸åŒ…å«
                            opt.classList.add('wrong-answer');
                        }
                    } else {
                        // å•é€‰é¢˜å’Œåˆ¤æ–­é¢˜
                        if (opt.dataset.option === question.answer) {
                            opt.classList.add('correct-answer');
                        } else if (selectedOptions === opt.dataset.option && !isCorrect) {
                            opt.classList.add('wrong-answer');
                        }
                    }
                });
                
                // æ›´æ–°æŒ‰é’®
                submitButton.style.display = 'none';
                nextButton.style.display = 'inline-block';
                
                // æ›´æ–°ç»Ÿè®¡å’Œé¢˜ç›®ç½‘æ ¼
                updateStats();
                updateQuestionGridItem(chapter, questionId);
                updateChapterImportStatus();
                updateOverallProgress();
                
                // å¦‚æœå½“å‰åœ¨é”™é¢˜æœ¬æ¨¡å¼ä¸‹ï¼Œåˆ·æ–°æ˜¾ç¤º
                if (currentMode === 'wrong') {
                    showWrongQuestions();
                }
            };
            
            // ä¸‹ä¸€é¢˜æŒ‰é’®äº‹ä»¶
            nextButton.onclick = function() {
                showNextQuestion();
            };
            
            // æ˜¾ç¤ºé¢˜ç›®é¡µé¢
            showQuestionPage();
        }
        
        // æ˜¾ç¤ºä¸‹ä¸€é¢˜
        function showNextQuestion() {
            let questions = [];
            
            if (currentMode === 'chapter') {
                questions = questionBank[currentChapter] || [];
                
                // å¦‚æœç« èŠ‚æœ‰æ‰“ä¹±é¡ºåºï¼Œä½¿ç”¨æ‰“ä¹±åçš„é¡ºåº
                const orderState = chapterOrderState[currentChapter] || { shuffled: false, order: [] };
                if (orderState.shuffled && orderState.order.length === questions.length) {
                    questions = orderState.order.map(id => questions.find(q => q.id === id)).filter(q => q);
                }
            } else if (currentMode === 'wrong') {
                questions = getAllWrongQuestions();
            } else if (currentMode === 'marked') {
                questions = getAllMarkedQuestions();
            }
            
            const currentIndex = questions.findIndex(q => 
                (currentMode === 'chapter' ? q.id === currentQuestion : (q.chapter === currentChapter && q.id === currentQuestion))
            );
            
            if (currentIndex < questions.length - 1) {
                if (currentMode === 'chapter') {
                    displayQuestion(currentChapter, questions[currentIndex + 1].id);
                } else {
                    const nextQuestion = questions[currentIndex + 1];
                    displayQuestion(nextQuestion.chapter, nextQuestion.id);
                }
            } else {
                // å¦‚æœæ˜¯æœ€åä¸€é¢˜ï¼Œå›åˆ°é¢˜ç›®ç½‘æ ¼
                showChapterPage();
            }
        }
        
        // æ˜¾ç¤ºä¸Šä¸€é¢˜
        function showPreviousQuestion() {
            let questions = [];
            
            if (currentMode === 'chapter') {
                questions = questionBank[currentChapter] || [];
                
                // å¦‚æœç« èŠ‚æœ‰æ‰“ä¹±é¡ºåºï¼Œä½¿ç”¨æ‰“ä¹±åçš„é¡ºåº
                const orderState = chapterOrderState[currentChapter] || { shuffled: false, order: [] };
                if (orderState.shuffled && orderState.order.length === questions.length) {
                    questions = orderState.order.map(id => questions.find(q => q.id === id)).filter(q => q);
                }
            } else if (currentMode === 'wrong') {
                questions = getAllWrongQuestions();
            } else if (currentMode === 'marked') {
                questions = getAllMarkedQuestions();
            }
            
            const currentIndex = questions.findIndex(q => 
                (currentMode === 'chapter' ? q.id === currentQuestion : (q.chapter === currentChapter && q.id === currentQuestion))
            );
            
            if (currentIndex > 0) {
                if (currentMode === 'chapter') {
                    displayQuestion(currentChapter, questions[currentIndex - 1].id);
                } else {
                    const prevQuestion = questions[currentIndex - 1];
                    displayQuestion(prevQuestion.chapter, prevQuestion.id);
                }
            }
        }
        
        // è·å–æ‰€æœ‰é”™é¢˜
        function getAllWrongQuestions() {
            const wrongQuestions = [];
            
            for (const chapter in questionBank) {
                if (questionBank.hasOwnProperty(chapter)) {
                    const questions = questionBank[chapter];
                    questions.forEach(q => {
                        const userAnswer = getUserAnswer(parseInt(chapter), q.id);
                        if (userAnswer && userAnswer !== '') {
                            const isCorrect = userAnswer === q.answer;
                            if (!isCorrect) {
                                wrongQuestions.push({
                                    ...q,
                                    chapter: parseInt(chapter)
                                });
                            }
                        }
                    });
                }
            }
            
            return wrongQuestions;
        }
        
        // è·å–æ‰€æœ‰æ ‡è®°é¢˜
        function getAllMarkedQuestions() {
            const markedQuestions = [];
            
            for (const chapter in questionBank) {
                if (questionBank.hasOwnProperty(chapter)) {
                    const questions = questionBank[chapter];
                    questions.forEach(q => {
                        if (isQuestionMarked(parseInt(chapter), q.id)) {
                            markedQuestions.push({
                                ...q,
                                chapter: parseInt(chapter)
                            });
                        }
                    });
                }
            }
            
            return markedQuestions;
        }
        
        // æ˜¾ç¤ºé”™é¢˜æœ¬
        function showWrongQuestions() {
            currentMode = 'wrong';
            currentChapter = 0;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.special-book-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('wrongQuestionsBook').classList.add('active');
            
            // æ›´æ–°ç« èŠ‚æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('chapterTitle').textContent = 'é”™é¢˜æœ¬';
            
            // è·å–æ‰€æœ‰é”™é¢˜
            const wrongQuestions = getAllWrongQuestions();
            
            // æ˜¾ç¤ºé”™é¢˜
            displaySpecialQuestions(wrongQuestions, 'é”™é¢˜æœ¬');
            
            // æ˜¾ç¤ºç« èŠ‚é¡µé¢
            showChapterPage();
        }
        
        // æ˜¾ç¤ºæ ‡è®°æœ¬
        function showMarkedQuestions() {
            currentMode = 'marked';
            currentChapter = 0;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.special-book-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('markedQuestionsBook').classList.add('active');
            
            // æ›´æ–°ç« èŠ‚æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('chapterTitle').textContent = 'æ ‡è®°æœ¬';
            
            // è·å–æ‰€æœ‰æ ‡è®°é¢˜
            const markedQuestions = getAllMarkedQuestions();
            
            // æ˜¾ç¤ºæ ‡è®°é¢˜
            displaySpecialQuestions(markedQuestions, 'æ ‡è®°æœ¬');
            
            // æ˜¾ç¤ºç« èŠ‚é¡µé¢
            showChapterPage();
        }
        
        // æ˜¾ç¤ºç‰¹æ®Šé¢˜ç›®ï¼ˆé”™é¢˜æœ¬ã€æ ‡è®°æœ¬ï¼‰
        function displaySpecialQuestions(questions, title) {
            const questionsGrid = document.getElementById('questionsGrid');
            
            if (questions.length === 0) {
                questionsGrid.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ“</i>
                        <p>${title}æš‚æ— é¢˜ç›®</p>
                    </div>
                `;
                return;
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateSpecialStats(questions);
            
            // åˆ›å»ºé¢˜ç›®ç½‘æ ¼
            let html = '';
            
            questions.forEach((q, index) => {
                const status = getUserAnswerStatus(q.chapter, q.id);
                const isMarked = isQuestionMarked(q.chapter, q.id);
                html += `<div class="question-item ${status} ${isMarked ? 'marked' : ''}" data-chapter="${q.chapter}" data-question="${q.id}">${index + 1}</div>`;
            });
            
            questionsGrid.innerHTML = html;
            
            // æ·»åŠ é¢˜ç›®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.question-item').forEach(item => {
                item.addEventListener('click', function() {
                    const chapter = parseInt(this.dataset.chapter);
                    const questionId = parseInt(this.dataset.question);
                    displayQuestion(chapter, questionId);
                });
            });
        }
        
        // éšæœºæ‰“ä¹±é€‰é¡¹ - æ”¯æŒæœ€å¤š6ä¸ªé€‰é¡¹ï¼ˆA-Fï¼‰
        function shuffleOptions(options, questionType) {
            // åˆ¤æ–­é¢˜ä¸éœ€è¦æ‰“ä¹±é€‰é¡¹
            if (questionType === 'true-false') {
                return options.map((option, index) => {
                    return {
                        text: option,
                        originalLabel: String.fromCharCode(65 + index) // A, B
                    };
                });
            }
            
            // å°†é€‰é¡¹ä¸æ ‡ç­¾é…å¯¹
            const optionPairs = options.map((option, index) => {
                return {
                    text: option,
                    originalLabel: String.fromCharCode(65 + index) // A, B, C, D, E, F
                };
            });
            
            // æ‰“ä¹±é€‰é¡¹é¡ºåº
            for (let i = optionPairs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [optionPairs[i], optionPairs[j]] = [optionPairs[j], optionPairs[i]];
            }
            
            return optionPairs;
        }
        
        // è·å–ç”¨æˆ·ç­”æ¡ˆ
        function getUserAnswer(chapter, questionId) {
            const key = `chapter_${chapter}_question_${questionId}`;
            const answerData = localStorage.getItem(key);
            return answerData ? JSON.parse(answerData).answer : '';
        }
        
        // è·å–ç”¨æˆ·ç­”æ¡ˆçŠ¶æ€
        function getUserAnswerStatus(chapter, questionId) {
            const key = `chapter_${chapter}_question_${questionId}`;
            const answerData = localStorage.getItem(key);
            
            if (!answerData) {
                return ''; // æœªç­”
            }
            
            const data = JSON.parse(answerData);
            return data.isCorrect ? 'correct' : 'wrong';
        }
        
        // æ£€æŸ¥é¢˜ç›®æ˜¯å¦è¢«æ ‡è®°
        function isQuestionMarked(chapter, questionId) {
            const key = `chapter_${chapter}_question_${questionId}`;
            const answerData = localStorage.getItem(key);
            
            if (!answerData) {
                return false;
            }
            
            const data = JSON.parse(answerData);
            return data.marked || false;
        }
        
        // è®¾ç½®é¢˜ç›®æ ‡è®°çŠ¶æ€
        function setQuestionMarked(chapter, questionId, marked) {
            const key = `chapter_${chapter}_question_${questionId}`;
            const answerData = localStorage.getItem(key);
            
            let data = {};
            if (answerData) {
                data = JSON.parse(answerData);
            }
            
            data.marked = marked;
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
        function saveUserAnswer(chapter, questionId, answer, isCorrect) {
            const key = `chapter_${chapter}_question_${questionId}`;
            const answerData = {
                answer: answer,
                isCorrect: isCorrect,
                timestamp: new Date().getTime(),
                marked: isQuestionMarked(chapter, questionId) // ä¿ç•™æ ‡è®°çŠ¶æ€
            };
            
            localStorage.setItem(key, JSON.stringify(answerData));
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (currentChapter === 0) return;
            
            const questions = questionBank[currentChapter] || [];
            let total = questions.length;
            let answered = 0;
            let correct = 0;
            let wrong = 0;
            
            questions.forEach(q => {
                const status = getUserAnswerStatus(currentChapter, q.id);
                if (status === 'correct') {
                    answered++;
                    correct++;
                } else if (status === 'wrong') {
                    answered++;
                    wrong++;
                }
            });
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
        }
        
        // æ›´æ–°ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ç»Ÿè®¡ä¿¡æ¯
        function updateSpecialStats(questions) {
            let total = questions.length;
            let answered = 0;
            let correct = 0;
            let wrong = 0;
            
            questions.forEach(q => {
                const status = getUserAnswerStatus(q.chapter, q.id);
                if (status === 'correct') {
                    answered++;
                    correct++;
                } else if (status === 'wrong') {
                    answered++;
                    wrong++;
                }
            });
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
        }
        
        // æ›´æ–°æ€»è¿›åº¦
        function updateOverallProgress() {
            let totalQuestions = 0;
            let answeredQuestions = 0;
            
            // éå†æ‰€æœ‰ç« èŠ‚
            for (const chapter in questionBank) {
                if (questionBank.hasOwnProperty(chapter)) {
                    const questions = questionBank[chapter];
                    totalQuestions += questions.length;
                    
                    // è®¡ç®—å·²ç­”é¢˜ç›®æ•°
                    answeredQuestions += questions.filter(q => {
                        const userAnswer = getUserAnswer(parseInt(chapter), q.id);
                        return userAnswer && userAnswer !== '';
                    }).length;
                }
            }
            
            // è®¡ç®—ç™¾åˆ†æ¯”
            const percentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
            document.getElementById('overallProgress').textContent = `æ€»è¿›åº¦: ${percentage}%`;
        }
        
        // æ›´æ–°é¢˜ç›®ç½‘æ ¼ä¸­çš„å•ä¸ªé¢˜ç›®çŠ¶æ€
        function updateQuestionGridItem(chapter, questionId) {
            const questionItem = document.querySelector(`.question-item[data-question="${questionId}"]`);
            if (questionItem) {
                const status = getUserAnswerStatus(chapter, questionId);
                const isMarked = isQuestionMarked(chapter, questionId);
                
                // é‡ç½®æ‰€æœ‰ç±»
                questionItem.className = 'question-item';
                
                // æ·»åŠ çŠ¶æ€ç±»
                if (isMarked) {
                    questionItem.classList.add('marked');
                } else if (status === 'correct') {
                    questionItem.classList.add('correct');
                } else if (status === 'wrong') {
                    questionItem.classList.add('wrong');
                } else if (status === 'answered') {
                    questionItem.classList.add('answered');
                }
            }
        }
        
        // æ¸…ç©ºæœ¬ç« ç­”é¢˜è®°å½•
        function clearChapterAnswers() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæœ¬ç« çš„ç­”é¢˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                const questions = questionBank[currentChapter] || [];
                questions.forEach(q => {
                    const key = `chapter_${currentChapter}_question_${q.id}`;
                    localStorage.removeItem(key);
                });
                
                // åˆ·æ–°æ˜¾ç¤º
                displayQuestionsGrid(currentChapter);
                updateStats();
                updateChapterImportStatus();
                updateOverallProgress();
            }
        }
        
        // æ¸…ç©ºå½“å‰ç« èŠ‚å†…å®¹
        function clearCurrentChapter() {
            if (!currentChapter) {
                alert('è¯·å…ˆé€‰æ‹©ç« èŠ‚');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºç¬¬${currentChapter}ç« çš„æ‰€æœ‰å†…å®¹å’Œç­”é¢˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                // åˆ é™¤å½“å‰ç« èŠ‚çš„é¢˜åº“
                delete questionBank[currentChapter];
                
                // åˆ é™¤å½“å‰ç« èŠ‚çš„æ‰€æœ‰ç­”é¢˜è®°å½•
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(`chapter_${currentChapter}_question_`)) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // ä¿å­˜æ›´æ–°åçš„é¢˜åº“
                saveQuestionBankToStorage();
                
                // åˆ·æ–°æ˜¾ç¤º
                displayQuestionsGrid(currentChapter);
                updateStats();
                updateChapterImportStatus();
                updateOverallProgress();
                
                alert(`ç¬¬${currentChapter}ç« å†…å®¹å·²æ¸…ç©º`);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¢˜åº“å’Œç­”é¢˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.clear();
                questionBank = {};
                chapterOrderState = {};
                
                // åˆ·æ–°æ˜¾ç¤º
                if (currentChapter) {
                    displayQuestionsGrid(currentChapter);
                }
                
                updateStats();
                updateChapterImportStatus();
                updateOverallProgress();
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }
        
        // å¯¼å…¥é¢˜åº“
        function importQuestions() {
            const textarea = document.getElementById('importTextarea');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('è¯·è¾“å…¥é¢˜åº“å†…å®¹');
                return;
            }
            
            try {
                // è§£æé¢˜åº“æ–‡æœ¬
                const parsedQuestions = parseQuestions(text);
                
                if (parsedQuestions.length === 0) {
                    alert('æœªæ‰¾åˆ°æœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                    return;
                }
                
                // å°†é¢˜ç›®æ·»åŠ åˆ°å½“å‰ç« èŠ‚
                const currentChapter = document.querySelector('.chapter-item.active')?.dataset.chapter || 1;
                
                if (!questionBank[currentChapter]) {
                    questionBank[currentChapter] = [];
                }
                
                // æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“
                parsedQuestions.forEach((q, index) => {
                    questionBank[currentChapter].push({
                        id: questionBank[currentChapter].length + 1,
                        question: q.question,
                        options: q.options,
                        answer: q.answer,
                        type: q.type
                    });
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveQuestionBankToStorage();
                
                // åˆ·æ–°æ˜¾ç¤º
                displayQuestionsGrid(currentChapter);
                updateStats();
                updateChapterImportStatus();
                updateOverallProgress();
                
                // æ¸…ç©ºæ–‡æœ¬åŒºåŸŸ
                textarea.value = '';
                
                alert(`æˆåŠŸå¯¼å…¥ ${parsedQuestions.length} é“é¢˜ç›®åˆ°ç¬¬${currentChapter}ç« `);
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }
        
        // è§£æé¢˜ç›®æ–‡æœ¬ - æ”¯æŒå•é€‰é¢˜ã€å¤šé€‰é¢˜å’Œåˆ¤æ–­é¢˜ï¼Œå¤šé€‰é¢˜æ”¯æŒæœ€å¤š6ä¸ªé€‰é¡¹ï¼ˆA-Fï¼‰
        function parseQuestions(text) {
            const questions = [];
            const lines = text.split('\n');
            
            let currentQuestion = null;
            let optionCount = 0;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                if (!line) continue;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯é¢˜ç›®è¡Œï¼ˆåŒ…å«ç­”æ¡ˆï¼‰- æ”¹è¿›çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ”¯æŒA-F
                if (line.match(/^\d+\./) || line.match(/^\d+ï¼/) || 
                    (line.includes('ï¼ˆ') && line.includes('ï¼‰') && line.match(/[ï¼ˆ(][A-Få¯¹é”™âˆšÃ—][ï¼‰)]/)) ||
                    (line.includes('(') && line.includes(')') && line.match(/[ï¼ˆ(][A-Få¯¹é”™âˆšÃ—][ï¼‰)]/)) ||
                    line.match(/^\d+\.(.+)\([å¯¹é”™âˆšÃ—]\)/)) {
                    
                    // å¦‚æœæœ‰æ­£åœ¨å¤„ç†çš„é¢˜ç›®ï¼Œå…ˆä¿å­˜
                    if (currentQuestion && optionCount >= 2) { // åˆ¤æ–­é¢˜è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹
                        questions.push(currentQuestion);
                    }
                    
                    // å¼€å§‹æ–°é¢˜ç›®
                    currentQuestion = {
                        question: '',
                        options: [],
                        answer: '',
                        type: 'single' // é»˜è®¤å•é€‰é¢˜
                    };
                    optionCount = 0;
                    
                    // æå–é¢˜ç›®å’Œç­”æ¡ˆ - æ”¹è¿›çš„ç­”æ¡ˆæå–ï¼Œæ”¯æŒA-F
                    const answerMatch = line.match(/[ï¼ˆ(]([A-Få¯¹é”™âˆšÃ—]+)[ï¼‰)]/) || 
                                       line.match(/[(]([A-Få¯¹é”™âˆšÃ—]+)[)]/) ||
                                       line.match(/\(([å¯¹é”™âˆšÃ—])\)/);
                    if (answerMatch) {
                        let answer = answerMatch[1];
                        
                        // åˆ¤æ–­é¢˜å¤„ç†
                        if (answer === 'å¯¹' || answer === 'âˆš' || answer === 'é”™' || answer === 'Ã—') {
                            currentQuestion.type = 'true-false';
                            currentQuestion.options = ['A.å¯¹', 'B.é”™'];
                            optionCount = 2; // åˆ¤æ–­é¢˜å›ºå®šæœ‰ä¸¤ä¸ªé€‰é¡¹
                            
                            if (answer === 'å¯¹' || answer === 'âˆš') {
                                currentQuestion.answer = 'A';
                            } else {
                                currentQuestion.answer = 'B';
                            }
                        } 
                        // å¤šé€‰é¢˜å¤„ç†
                        else if (answer.length > 1) {
                            currentQuestion.type = 'multiple';
                            currentQuestion.answer = answer.split('').sort().join('');
                        }
                        // å•é€‰é¢˜å¤„ç†
                        else {
                            currentQuestion.answer = answer;
                        }
                        
                        // ç§»é™¤ç­”æ¡ˆéƒ¨åˆ†
                        currentQuestion.question = line.replace(/[ï¼ˆ(][A-Få¯¹é”™âˆšÃ—]+[ï¼‰)]/, '')
                                                       .replace(/[(][A-Få¯¹é”™âˆšÃ—]+[)]/, '')
                                                       .replace(/\([å¯¹é”™âˆšÃ—]\)/, '')
                                                       .trim();
                    } else {
                        currentQuestion.question = line;
                    }
                }
                // æ£€æŸ¥æ˜¯å¦æ˜¯é€‰é¡¹ - æ”¹è¿›çš„é€‰é¡¹è¯†åˆ«ï¼ˆéåˆ¤æ–­é¢˜æ‰æœ‰é€‰é¡¹è¡Œï¼‰ï¼Œæ”¯æŒA-F
                else if ((line.match(/^[A-F][\.ï¼\s]/) || line.match(/^[A-F]\./) || line.match(/^[A-F]ï¼/)) && 
                         currentQuestion && currentQuestion.type !== 'true-false') {
                    // æ¸…ç†é€‰é¡¹æ ¼å¼
                    let cleanOption = line.replace(/^[A-F][\.ï¼\s]*/, '');
                    cleanOption = cleanOption.trim();
                    currentQuestion.options.push(`${line.charAt(0)}. ${cleanOption}`);
                    optionCount++;
                }
                // å…¶ä»–æƒ…å†µï¼Œå¯èƒ½æ˜¯é¢˜ç›®å†…å®¹çš„å»¶ç»­
                else if (currentQuestion && !currentQuestion.options.length && currentQuestion.type !== 'true-false') {
                    currentQuestion.question += ' ' + line;
                }
            }
            
            // æ·»åŠ æœ€åä¸€ä¸ªé¢˜ç›®
            if (currentQuestion && (optionCount >= 2 || currentQuestion.type === 'true-false')) {
                questions.push(currentQuestion);
            }
            
            return questions;
        }
        
        // å¯¼å‡ºé¢˜åº“
        function exportQuestionBank() {
            if (Object.keys(questionBank).length === 0) {
                alert('å½“å‰æ²¡æœ‰é¢˜åº“æ•°æ®å¯ä»¥å¯¼å‡º');
                return;
            }
            
            const dataStr = JSON.stringify(questionBank, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'èŒä¸šå¥åº·é¢˜åº“.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('é¢˜åº“å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åä¸ºï¼šèŒä¸šå¥åº·é¢˜åº“.json');
        }
        
        // ä¿å­˜é¢˜åº“åˆ°æœ¬åœ°å­˜å‚¨
        function saveQuestionBankToStorage() {
            localStorage.setItem('questionBank', JSON.stringify(questionBank));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½é¢˜åº“
        function loadQuestionBankFromStorage() {
            const stored = localStorage.getItem('questionBank');
            if (stored) {
                questionBank = JSON.parse(stored);
                updateChapterImportStatus();
                updateStats();
                updateOverallProgress();
            }
        }
    </script>
</body>
</html>